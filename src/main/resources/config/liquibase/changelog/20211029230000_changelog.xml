<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.9.xsd">
    <changeSet author="imstreetspirit" id="20211029230000">
        <sql>
            UPDATE feedback f
            INNER JOIN grading_instruction gi ON f.grading_instruction_id = gi.id
            INNER JOIN result r ON f.result_id = r.id
            INNER JOIN submission s ON r.submission_id = s.id
            SET f.detail_text = REPLACE(f.detail_text,gi.feedback,'')
            WHERE s.discriminator in ('T', 'P', 'F')
            AND (f.detail_text = gi.feedback
            OR f.detail_text LIKE CONCAT (gi.feedback, '%'));

            UPDATE feedback f
            INNER JOIN grading_instruction gi ON f.grading_instruction_id = gi.id
            INNER JOIN result r ON f.result_id = r.id
            INNER JOIN submission s ON r.submission_id = s.id
            SET f.text = REPLACE(f.text,gi.feedback,'')
            WHERE s.discriminator in ('M')
            AND (f.text = gi.feedback
            OR f.text LIKE CONCAT (gi.feedback, '%'));
        </sql>
    </changeSet>
</databaseChangeLog>
