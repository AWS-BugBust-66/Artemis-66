name: Run Cypress E2E Tests
on: push

env:
  CI: true
  node: 14.x
  java: 16

jobs:
  execute-tests:
    runs-on: ubuntu-latest
#    environment:
#        name: artemistest5-e2e-tests
#        url: https://artemistest5.ase.in.tum.de
#    concurrency: cypress-tests
    
    services:
      mysql:
        image: mysql:8.0.25
        env:
          MYSQL_ROOT_PASSWORD: rootPassword
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2.4.1
        with:
          node-version: '${{ env.node }}'
          cache: 'npm'
      - name: Setup Java
        uses: actions/setup-java@v2.3.1
        with:
          distribution: 'zulu'
          java-version: '${{ env.java }}'
          cache: 'gradle'
      - name: Production Build
        run: ./gradlew -Pprod -Pwar clean bootWar
        env:
          NODE_OPTIONS: --max_old_space_size=6144
      
      - name: Copy configuration files
        run: cp src/test/cypress/deployment/* build/libs/
      - name: Import sql dump
        run: mysql --host=localhost --port=3306 --protocol=TCP --user=root --password=rootPassword < build/libs/*.sql
      - name: Start Artemis
        env:
          SPRING_DATASOURCE_PASSWORD: rootPassword
          SPRING_PROFILES_ACTIVE: dev,gitlab,jenkins,artemis,scheduling
        run: cd build/libs; java -jar *.war

      - name: Run Cypress Tests
        uses: cypress-io/github-action@v2
        with:
          working-directory: src/test/cypress
          browser: chrome
          install-command: yarn install --frozen-lockfile
          config: baseUrl=http://localhost:8080
          env: username=${{ secrets.BAMBOO_TEST_USER }},password=${{ secrets.BAMBOO_TEST_PASSWORD }},adminUsername=${{ secrets.BAMBOO_ADMIN_USER }},adminPassword=${{ secrets.BAMBOO_ADMIN_PASSWORD }}
